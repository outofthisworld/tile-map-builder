<html>

<head>

    <title>Map builder</title>

    <style>
        * {
            margin: 0px;
            padding: 0px;
        }

        .container {
            width: 100%;
            margin: 0 auto;
        }

        .container .main_section {
            width: 60%;
            float: left;
        }

        .container .main_section canvas {
            width: 100%;
            height: 100%;
        }

        .container .side_bar {
            width: 30%;
            float: left;
            height: 100%;
            overflow: scroll;
        }

        #tiles_list {
            list-style-type: none;
            width: 100%;
            height: 100%;
            overflow: scroll;
            border: 2px solid #f3f3f3;
        }

        #tiles_list li {
            width: 100%;
            height: 80px;
            max-height: 80px;
            min-height: 80px;
        }

        #tiles_list li img {
            display: block;
            margin: 0 auto;
            width: 80%;
            height: 80px;
            max-height: 80px;
            min-height: 80px;
        }

        input {
            display: block;
            margin: 5px auto;
            width: 80%;
            padding: 10px;
            border: none;
        }

        input[type="button"] {
            padding: 15px;
            background: violet;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            color: white;
            text-transform: uppercase;
        }

        input[type="number"] {
            width: 50%;
            padding: 5px;
            margin-left: 40%;
        }

        input:not(:focus) {
            border: 2px solid #f3f3f3;
        }

        small {
            padding-left: 12%;
            font-family: 'Lucida Sans', 'Lucida Sans Regular', 'Lucida Grande', 'Lucida Sans Unicode', Geneva, Verdana, sans-serif
        }

        .zoom {
            position: absolute;
            top: 60px;
            left: 10px;
            width: 5%;
        }

        #zoom_out {
            left: 6%;
        }

        .middle_section {
            text-align: center;
            width: 10%;
            min-width: 10%;
            float: left;
        }

        .side_bar textarea {
            display: block;
            width: 80%;
            margin: 0 auto;
            min-height: 150px;
            max-width: 90%;
            min-width: 80%;
        }
        nav{
            width:100%;
            list-style-type: none; 
            text-align:right;
        }
        nav li{
            display:inline-block;
            padding:10px;
            background:violet;
            color:white;
        }
        nav li:hover{
            background:pink;
            cursor:pointer;
        }
    </style>
</head>

<body>
    <nav>
        <li id="save_map">
            Save
        </li>
         <li id="load_map">
            Load
        </li>
    </nav>
    <div class="container">
        <div class="main_section">
            <canvas id="map_canvas"></canvas>
        </div>
        <div class="middle_section">
            <ul id="tiles_list">
                Textures:
                <ul>
        </div>
        <div class="side_bar">
            <small>Canvas fill:</small>
            <input id="canvas_fill" type="text" placeholder="e.g black,#f3f3f3,rgba(22,22,22,0)" />
            <small>Grid color:</small>
            <input id="grid_color" type="text" placeholder="e.g black,#f3f3f3,rgba(22,22,22,0)" />
            <small>Map size:</small>
            <input id="map_size_tiles_x" min="1" type="number" placeholder="Number of tiles x" required/>
            <input id="map_size_tiles_y" min="1" type="number" placeholder="Number of tiles y" required/>
            <input id="tile_width" type="number" min="1" placeholder="Tile width" required/>
            <input id="tile_height" type="number" min="1" placeholder="Tile height" required/>
            <input type="button" value="Generate tile map" id="generate_map" />
            <small>Choose an image:</small>
            <input id="image" type="file" accept="image/*" />

            <small>Make the image a background image:</small>
            <input id="bg_img_x" type="number" placeholder="x position" required/>
            <input id="bg_img_y" type="number" placeholder="y position" required/>
            <input id="bg_img_width" type="number" placeholder="width" required/>
            <input id="bg_img_y" type="number" placeholder="height" required/>
            <input type="button" value="Add as background" id="add_background_image" />
            </hr>
            <small>Make the image a tile image:</small>
            <input type="button" value="Add tile texture" id="add_tile_image" />
            <small>Generated map data:</small>
            <textarea id="map_data" disabled>

            </textarea>
            <div>
            </div>

            <input type="button" value="+" class="zoom" id="zoom_in" />
            <input type="button" value="-" class="zoom" id="zoom_out" />

            <script>
                const map_canvas = document.getElementById('map_canvas'),
                    ctx = map_canvas.getContext('2d');
                let map = [],
                    tWidth = 0,
                    tHeight = 0,
                    mapOffsetX = 0,
                    mapOffsetY = 0,
                    scale = 1,
                    selectedTexture = null,
                    currentTextureID = 0,
                    toPanX = 0,
                    toPanY = 0,
                    fc = 0;

                let r = map_canvas.getBoundingClientRect();
                map_canvas.width = 800;
                map_canvas.height = 1000;

                document.getElementById('zoom_in').onclick = function (event) {
                    scale += 0.1;
                }

                document.getElementById('zoom_out').onclick = function (event) {
                    scale -= 0.1;
                }

                let mouseDownEvent = null;
                map_canvas.onmousedown = function (event) {
                    mouseDownEvent = event;
                }

                map_canvas.onmouseup = function (event) {
                    mouseDownEvent = null;
                }
                map_canvas.onmousemove = function (event) {
                    const rect = map_canvas.getBoundingClientRect();

                    const cX = event.clientX - rect.left;
                    const cY = event.clientY - rect.top;

                    const boundingRectWidth = rect.right - rect.left;
                    const boundingRectHeight = rect.bottom - rect.top;

                    const ratioX = map_canvas.width / boundingRectWidth;
                    const ratioY = map_canvas.height / boundingRectHeight;

                    const canvasX = cX * ratioX;
                    const canvasY = cY * ratioY;


                    if (map.length && canvasX >= Math.abs(mapOffsetX) && canvasX <= (map.length * tWidth * scale) - mapOffsetX
                        && canvasY >= Math.abs(mapOffsetY) && canvasY < (map[0].length * tHeight * scale) - mapOffsetY) {
                        map_canvas.style.cursor = 'pointer';
                        if (mouseDownEvent) {
                            if (selectedTexture) {
                                const aX = Math.floor((canvasX + mapOffsetX) / (64 * scale));
                                const aY = Math.floor((canvasY + mapOffsetY) / (64 * scale));
                                map[aX][aY] = selectedTexture;
                            } else {
                                const aX = Math.floor((canvasX + mapOffsetX) / (64 * scale));
                                const aY = Math.floor((canvasY + mapOffsetY) / (64 * scale));
                                map[aX][aY] = { color: 'red' };
                            }
                            generateMapData();

                            mouseDownEvent = null;
                        }
                    } else {
                        if (mouseDownEvent) {
                            const dX = mouseDownEvent.clientX - event.clientX;
                            const dY = mouseDownEvent.clientY - event.clientY;
                            mapOffsetX = dX;
                            mapOffsetY = dY;
                        }
                        map_canvas.style.cursor = "move";
                    }
                }

                window.addEventListener('keydown', function (event) {
                    console.log(event.keyCode);
                    switch (event.keyCode) {
                        case 37:
                            toPanX -= 50;
                            break;
                        case 38:
                            toPanY -= 50;
                            break;
                        case 39:
                            toPanX += 50;
                            break;
                        case 40:
                            toPanY += 50;
                            break;
                    }
                    fc = 0;
                })

                let lt = Date.now();
                function up() {
                    requestAnimationFrame(up);
                    const ct = Date.now();
                    const timePassed = ct - lt;
                    const currentFPS = 1000 / timePassed;
                    lt = ct;
                    if (fc >= currentFPS) {
                        toPanX = 0;
                        toPanY = 0;
                    }
                    mapOffsetX += toPanX / currentFPS;
                    mapOffsetY += toPanY / currentFPS;
                    fc++;
                    ctx.clearRect(0, 0, map_canvas.width, map_canvas.height);
                    ctx.fillStyle = document.getElementById('canvas_fill').value || '#F3F3F3';
                    ctx.fillRect(0, 0, map_canvas.width, map_canvas.height);
                    for (let i = 0; i < map.length; i++) {
                        for (let j = 0; j < map[i].length; j++) {
                            ctx.strokeStyle = document.getElementById('grid_color').value || 'orange';
                            if (!map[i][j]) {
                                ctx.strokeRect((i * tWidth * scale) - mapOffsetX, (j * tHeight * scale) - mapOffsetY, tWidth * scale, tHeight * scale);
                            } else {
                                if (map[i][j].image) {
                                    ctx.drawImage(map[i][j].image, (i * tWidth * scale) - mapOffsetX, (j * tHeight * scale) - mapOffsetY, tWidth * scale, tHeight * scale)
                                } else if (map[i][j].color) {
                                    ctx.fillStyle = map[i][j].color;
                                    ctx.fillRect((i * tWidth * scale) - mapOffsetX, (j * tHeight * scale) - mapOffsetY, tWidth * scale, tHeight * scale)
                                }
                            }
                        }
                    }
                }
                requestAnimationFrame(up);

                const tiles_list = document.getElementById('tiles_list');
                const tile_button = document.getElementById('add_tile_image');
                document.getElementById('image').onchange = function (event) {
                    var reader = new FileReader();
                    reader.onload = function () {
                        tile_button.setAttribute('data-file-target', reader.result);
                    };
                    reader.readAsDataURL(event.target.files[0])
                }

                document.getElementById('generate_map').onclick = function (event) {
                    const tilesX = document.getElementById('map_size_tiles_x').value;
                    const tilesY = document.getElementById('map_size_tiles_y').value;
                    const tileWidth = document.getElementById('tile_width').value;
                    const tileHeight = document.getElementById('tile_height').value;

                    const errors = [];
                    if (isNaN(tilesX) || parseInt(tilesX) <= 0) {
                        errors[errors.length] = 'Map x tiles must be above 0';
                    }
                    if (isNaN(tilesY) || parseInt(tilesY) <= 0) {
                        errors[errors.length] = 'Map y tiles must be above 0';
                    }
                    if (isNaN(tileWidth) || parseInt(tileWidth) <= 0) {
                        errors[errors.length] = 'tile width must be above 0';
                    }
                    if (isNaN(tileHeight) || parseInt(tileHeight) <= 0) {
                        errors[errors.length] = 'tile height must be above 0';
                    }

                    if (errors.length > 0) {
                        alert(errors.join(':'));
                        return;
                    }

                    const newmap = []

                    for (let i = 0; i < tilesX; i++) {
                        newmap[i] = newmap[i] || [];
                        for (let j = 0; j < tilesY; j++) {
                            newmap[i][j] = 0;
                        }
                    }

                    for (let i = 0; i < map.length; i++) {
                        if (i >= newmap.length) break;
                        for (let j = 0; j < map[i].length; j++) {
                            if (j >= newmap[i].length) break;
                            newmap[i][j] = map[i][j];
                        }
                    }

                    tWidth = tileWidth;
                    tHeight = tileHeight;
                    map = newmap;
                    generateMapData();
                }

                document.getElementById('add_tile_image').onclick = function (event) {
                    if (!tile_button.hasAttribute('data-file-target')) {
                        alert('Please select a file')
                        return;
                    }
                    currentTextureID++;
                    const url = tile_button.getAttribute('data-file-target');
                    const li = document.createElement('li');
                    const imgElement = document.createElement('img');
                    imgElement.src = url;

                    tile_button.removeAttribute('data-file-target');

                    //Format list
                    li.classList.add('li');
                    li.setAttribute('data-id', currentTextureID);
                    imgElement.setAttribute('data-id', currentTextureID);
                    imgElement.onclick = function (event) {
                        const eles = document.querySelectorAll('#tiles_list li img');
                        for (let i = 0; i < eles.length; i++) {
                            eles[i].style.border = 'none';
                        }
                        imgElement.style.border = '2px solid red';
                        selectedTexture = {
                            id: currentTextureID,
                            image: imgElement
                        };
                    }
                    li.appendChild(imgElement);
                    tiles_list.appendChild(li);

                    //Reset
                    document.getElementById('image').value = '';
                }

                function generateMapData() {
                    const map_data = document.getElementById('map_data');
                    map_data.textContent = "";
                    map_data.textContent += "const tile_sprites = {\n"
                    map_data.textContent += `createImageWithUrl:function(url){
                        const img = document.createElement('img');
                        img.src = url;
                        return img;
                    },\n`;
                    const textures = document.querySelectorAll('#tiles_list li');
                    for (let i = 0; i < textures.length; i++) {
                        const li = textures[i];
                        const id = li.getAttribute('data-id');
                        const img = li.children[0];
                        console.dir(img)
                        map_data.textContent += `${id}:this.createImageWithUrl('images/tile${id}.png'),\n`
                    }
                    map_data.textContent = map_data.textContent.substr(0, map_data.textContent.length - 2);
                    map_data.textContent += "}";
                    map_data.textContent += "\nconst _map = [";
                    for (let i = 0; i < map.length; i++) {
                        map_data.textContent += "[";
                        for (let j = 0; j < map[i].length; j++) {
                            map_data.textContent += ((map[i][j].id ? map[i][j].id : "0") + ",");
                        }
                        map_data.textContent = map_data.textContent.substr(0, map_data.textContent.length - 1);
                        map_data.textContent += "],";
                    }
                    map_data.textContent = map_data.textContent.substr(0, map_data.textContent.length - 1);
                    map_data.textContent += "]";
                }

                document.getElementById('save_map').onclick = function(event){
                    const object_to_serialize = {
                        tWidth,
                        tHeight
                    }
                    const imgs = {}
                    const textures = document.querySelectorAll('#tiles_list li');
                    for (let i = 0; i < textures.length; i++) {
                        const li = textures[i];
                        const id = li.getAttribute('data-id');
                        const img = li.children[0];
                        imgs[id] = img.src;
                    }

                    object_to_serialize.map = map;
                    object_to_serialize.textures = imgs;
                    const serializedObj = JSON.stringify(object_to_serialize);
                    var a = document.createElement("a");
                    var file = new Blob([serializedObj], {type: 'application/json'});
                    a.href = URL.createObjectURL(file);
                    a.download = 'map';
                    a.click();
                }

                document.getElementById('load_map').onclick = function(event){
                    const input = document.createElement('input');
                    input.type='file';
                    input.accept='application/json';
                    input.onchange = function(event){
                        const reader = new FileReader();
                        reader.onload = function () {
                            let json = reader.result;

                            try{
                                json = JSON.parse(json);
                            }catch(err){
                                alert('Error loading json file');
                                return;
                            }

                            if(!json.map || !json.textures ||  json.tWidth == null || isNaN(json.tWidth) || json.tHeight == null || isNaN(json.tHeight)){
                                alert('Invalid json file format');
                                return;
                            }

                            const textures = json.textures;
                            
                            for(key in textures){
                                const li = document.createElement('li');
                                li.setAttribute('data-id',key);
                                const img = document.createElement('img');
                                img.src = textures[key];
                                img.setAttribute('data-id',key);
                                li.appendChild(img);
                                img.onclick = function (event) {
                                    const eles = document.querySelectorAll('#tiles_list li img');
                                    for (let i = 0; i < eles.length; i++) {
                                        eles[i].style.border = 'none';
                                    }
                                    img.style.border = '2px solid red';
                                    selectedTexture = {
                                        id: key,
                                        image: img
                                    };
                                }
                                const tiles_list = document.getElementById('tiles_list');
                                tiles_list.appendChild(li);
                                textures[key].img = img;
                                currentTextureID = key;
                            }

                            const loaded_map = json.map;

                            if(!Array.isArray(loaded_map)){
                                alert('Invalid json file format');
                                return;
                            }

                            for(let i = 0; i <loaded_map.length;i++){
                                for(let j = 0; j <loaded_map[i].length;j++){
                                    if(loaded_map[i][j]){
                                        loaded_map[i][j].image = textures[loaded_map[i][j].id].img;
                                    }
                                }
                            }

                            map = loaded_map;
                            tWidth = parseInt(json.tWidth);
                            tHeight = parseInt(json.tHeight);
                            generateMapData();
                        };
                        reader.readAsText(event.target.files[0])
                    }
                    input.click();
                }
            </script>
</body>

</html>